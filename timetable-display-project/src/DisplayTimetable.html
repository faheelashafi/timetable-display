<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Display</title>
    <link rel="stylesheet" href="../styles/styles.css">
</head>
<body>
    <div class="timetable-header">
        <h1>Time Table</h1>
        <h3>DEPT. OF CS & IT - University of Chakwal</h3>
    </div>
    <div class="table-container">
        <table class="table" id="timetableDisplay">
            <thead>
                <tr>
                    <th>Day</th>
                    <th>Session</th>
                    <th>01:00-01:30</th>
                    <th>01:30-02:00</th>
                    <th>02:00-02:30</th>
                    <th>02:30-03:00</th>
                    <th>03:00-03:30</th>
                    <th>03:30-04:00</th>
                    <th>04:00-04:30</th>
                    <th>04:30-05:00</th>
                    <th>05:00-05:30</th>
                    <th>05:30-06:00</th>
                    <th>06:00-06:30</th>
                    <th>06:30-07:00</th>
                </tr>
            </thead>
            <tbody id="timetableBody">
                <!-- Timetable entries will be displayed here -->
            </tbody>
        </table>
    </div>
    <div style="text-align: center; margin-top: 20px;">
        <p id="entriesCount" style="font-size: 12px; color: #666;"></p>
    </div>

    <!-- Load scripts -->
    <script src="../scripts/timetable.js"></script>
    
    <script>
        // Time conversion helper function
        function convertToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(num => parseInt(num, 10));
            return hours * 60 + minutes;
        }
        
        // Custom renderTimetable function that works
        function renderTimetable(entries) {
            console.log("Rendering", entries.length, "entries to timetable");
            
            const tableBody = document.getElementById('timetableBody');
            tableBody.innerHTML = '';
            
            if (!entries || entries.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 14;
                cell.textContent = 'No timetable entries found. Please add entries in the Admin Panel.';
                cell.style.textAlign = 'center';
                cell.style.padding = '20px';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }
            
            // Group by days
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            // Time slots for column matching
            const timeSlots = [
                '01:00', '01:30', '02:00', '02:30', '03:00', '03:30',
                '04:00', '04:30', '05:00', '05:30', '06:00', '06:30'
            ];
            
            // Process each day
            days.forEach(day => {
                const dayEntries = entries.filter(entry => entry.day === day);
                if (dayEntries.length === 0) return;
                
                // Get unique sessions for this day
                const sessions = [...new Set(dayEntries.map(entry => entry.session))].sort();
                
                // Create a row for each session
                sessions.forEach((session, sessionIndex) => {
                    const row = document.createElement('tr');
                    row.classList.add(`batch-${session}`);
                    
                    // Add day cell (only for first session of the day)
                    if (sessionIndex === 0) {
                        const dayCell = document.createElement('td');
                        dayCell.className = 'day-cell';
                        dayCell.textContent = day;
                        dayCell.rowSpan = sessions.length;
                        row.appendChild(dayCell);
                    }
                    
                    // Add session cell
                    const sessionCell = document.createElement('td');
                    sessionCell.className = 'session-cell';
                    sessionCell.textContent = session;
                    row.appendChild(sessionCell);
                    
                    // Get entries for this session on this day
                    const sessionEntries = dayEntries.filter(entry => entry.session === session);
                    
                    // Process each time slot
                    for (let i = 0; i < timeSlots.length; i++) {
                        const slotTime = timeSlots[i];
                        const slotMinutes = convertToMinutes(slotTime);
                        
                        // Find entry that overlaps with this time slot
                        const entry = sessionEntries.find(e => {
                            const startMinutes = convertToMinutes(e.startTime);
                            const endMinutes = convertToMinutes(e.endTime);
                            return slotMinutes >= startMinutes && slotMinutes < endMinutes;
                        });
                        
                        // If we found an entry and haven't added it yet
                        if (entry) {
                            // Calculate how many slots this entry spans
                            const startMinutes = convertToMinutes(entry.startTime);
                            const endMinutes = convertToMinutes(entry.endTime);
                            const spanCount = Math.ceil((endMinutes - startMinutes) / 30);
                            
                            // Skip slots we've already processed with earlier entries
                            if (i > 0) {
                                const prevTime = timeSlots[i-1];
                                const prevEntry = sessionEntries.find(e => {
                                    const startMin = convertToMinutes(e.startTime);
                                    const endMin = convertToMinutes(e.endTime);
                                    return convertToMinutes(prevTime) >= startMin && convertToMinutes(prevTime) < endMin;
                                });
                                if (prevEntry && prevEntry.id === entry.id) {
                                    continue; // Skip this slot as it's already covered
                                }
                            }
                            
                            // Create cell for this entry
                            const cell = document.createElement('td');
                            cell.className = 'course-cell';
                            if (entry.isLab) {
                                cell.classList.add('lab-course');
                                cell.textContent = entry.courseCode + ' Lab';
                            } else {
                                cell.textContent = entry.courseCode;
                            }
                            
                            // Make the cell span multiple columns if needed
                            cell.colSpan = Math.min(spanCount, timeSlots.length - i);
                            
                            // Add tooltip with course details
                            cell.title = `${entry.courseName}\nTeacher: ${entry.teacherName || 'N/A'}\nVenue: ${entry.venue || 'N/A'}`;
                            
                            row.appendChild(cell);
                            
                            // Skip the slots this entry spans
                            i += cell.colSpan - 1;
                        } else {
                            // Empty cell for this time slot
                            const cell = document.createElement('td');
                            row.appendChild(cell);
                        }
                    }
                    
                    tableBody.appendChild(row);
                });
            });
            console.log("Timetable rendering complete");
        }

        // Wait until everything is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded");
            
            // Load entries immediately
            loadAndRenderTimetable();
        });
        
        // Function to load and render timetable entries
        function loadAndRenderTimetable() {
            try {
                console.log("Loading timetable entries...");
                const entriesJson = localStorage.getItem('timetableEntries');
                console.log("Raw entries data:", entriesJson ? entriesJson.substring(0, 100) + "..." : "none");
                
                const entries = JSON.parse(entriesJson) || [];
                document.getElementById('entriesCount').textContent = `Found ${entries.length} entries in localStorage`;
                
                // Use our local renderTimetable function
                renderTimetable(entries);
            } catch (e) {
                console.error("Error loading timetable entries:", e);
                document.getElementById('entriesCount').textContent = `Error: ${e.message}`;
            }
        }
    </script>
</body>
</html>