<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Timetable</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <!-- Load the JavaScript BEFORE the module imports -->
    <script src="../scripts/timetable.js"></script>
</head>
<body class="timetable-view">
    <!-- Ultra-compact header with minimal margin/padding -->
    <div class="ultra-compact-header">
        <h1>Time Table</h1>
        <h2>DEPT. OF CS &amp; IT - University of Chakwal</h2>
    </div>

    <!-- Container to hold the timetable -->
    <div id="timetable-container" class="table-container">
        <!-- Empty div to be filled by JavaScript -->
    </div>

    <!-- Single module script for Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, setDoc, doc, 
                 deleteDoc, getDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        
        // Add this to make the function globally available
        window.setupAndVerifyDepartmentEntries = setupAndVerifyDepartmentEntries;

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DisplayTimetable initializing...");
            try {
                // Get department from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const department = urlParams.get('dept') || 'cs'; // Default to CS if not specified
                
                // Set the title based on department
                const departmentNames = {
                    'cs': 'Computer Science & IT',
                    'eng': 'Engineering',
                    'pharm': 'Pharmacy & HND'
                };
                
                document.querySelector('.ultra-compact-header h1').textContent = 
                    `Time Table - ${departmentNames[department] || 'All Departments'}`;
                document.querySelector('.ultra-compact-header h2').textContent = 
                    `DEPT. OF ${departmentNames[department].toUpperCase()} - University of Chakwal`;
                
                // Store these functions globally so they can be used by setupRealtimeUpdates
                window.onSnapshotImport = onSnapshot;
                window.collectionImport = collection;
                
                // Call the setupFirebase function with the imported modules
                if (typeof window.setupFirebase === 'function') {
                    window.setupFirebase({
                        initializeApp,
                        getFirestore,
                        collection,
                        getDocs,
                        addDoc,
                        setDoc,
                        doc,
                        deleteDoc,
                        getDoc,
                        updateDoc,
                        arrayUnion,
                        arrayRemove,
                        onSnapshot
                    });
                    
                    // Now we can call other functions that depend on Firebase
                    if (typeof window.renderEmptyTimetableGrid === 'function') {
                        window.renderEmptyTimetableGrid();
                    }
                    
                    if (typeof window.setupRealtimeUpdates === 'function') {
                        window.setupRealtimeUpdates();
                    }
                    
                    // Add this new function call
                    if (typeof window.setupAndVerifyDepartmentEntries === 'function') {
                        window.setupAndVerifyDepartmentEntries();
                    }
                    
                    console.log("DisplayTimetable initialization complete");
                } else {
                    console.error("setupFirebase function not found!");
                }
            } catch (error) {
                console.error("Error initializing timetable:", error);
            }
        });
    </script>
</body>
</html>